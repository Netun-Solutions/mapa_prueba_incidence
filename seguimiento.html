<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Seguimiento de Grúa</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style> #map { height: 100vh; width: 100vw; } </style>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
</head>
<body>
<div id="map"></div>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
  // ICONOS
  const iconGrua = L.icon({
    iconUrl: 'https://cdn-icons-png.flaticon.com/512/1479/1479603.png',
    iconSize: [42, 42],
    iconAnchor: [21, 41]
  });
  const iconCoche = L.icon({
    iconUrl: 'https://cdn-icons-png.flaticon.com/512/744/744465.png',
    iconSize: [36, 36],
    iconAnchor: [18, 35]
  });

  // Obtener parámetros de la URL
  const params = new URLSearchParams(window.location.search);
  const latDestino = parseFloat(params.get("lat"));
  const lonDestino = parseFloat(params.get("lon"));

  // Punto inicial grúa (ajusta la distancia si quieres)
  const dx = 0.01, dy = 0.01; // aprox 1km NE
  const latGrua = latDestino + dy;
  const lonGrua = lonDestino + dx;

  // Inicializar mapa
  const map = L.map('map').setView([latDestino, lonDestino], 14);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

  // Marcador usuario (coche)
  const cocheMarker = L.marker([latDestino, lonDestino], {icon: iconCoche}).addTo(map).bindPopup("Tu ubicación (coche)").openPopup();
  // Marcador grúa (movible)
  let gruaMarker = L.marker([latGrua, lonGrua], {icon: iconGrua}).addTo(map).bindPopup("Grúa en camino").openPopup();

  // Consultar ruta OSRM
  async function getRoute() {
    const url = `https://router.project-osrm.org/route/v1/driving/${lonGrua},${latGrua};${lonDestino},${latDestino}?overview=full&geometries=geojson`;
    const resp = await fetch(url);
    const data = await resp.json();
    if (!data.routes || !data.routes[0]) {
      alert('No se pudo calcular la ruta.');
      return [];
    }
    return data.routes[0].geometry.coordinates.map(([lng, lat]) => [lat, lng]);
  }

  // Dibujar ruta y mover la grúa por ella
  getRoute().then(routeCoords => {
    if (routeCoords.length === 0) return;

    // Dibujar la ruta
    const routeLine = L.polyline(routeCoords, {color: 'blue', weight: 6, opacity: 0.7}).addTo(map);
    map.fitBounds(routeLine.getBounds().pad(0.2));

    // Mover la grúa paso a paso
    let step = 0;
    function moveGrua() {
      if (step < routeCoords.length) {
        gruaMarker.setLatLng(routeCoords[step]);
        step++;
        setTimeout(moveGrua, 2500); // Cambia velocidad aquí (ms)
      } else {
        gruaMarker.bindPopup("¡La grúa ha llegado!").openPopup();
      }
    }
    moveGrua();
  });
</script>
</body>
</html>
